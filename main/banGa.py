import pygame as pg 
import random
import menu
from menu import *
import math
# Kh·ªüi t·∫°o pygame
pygame.init()
pg.mixer.init()
pg.mixer.music.load("data/nhacnen1.mp3")


# Ph√°t nh·∫°c n·ªÅn l·∫∑p v√¥ h·∫°n
pg.mixer.music.play(-1)

# C·∫•u h√¨nh c·ª≠a s·ªï game
WIDTH, HEIGHT = 1024, 720
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Chicken Invaders")

# Load h√¨nh n·ªÅn
background_img = pygame.image.load("data/bg6.jpg")
background = pygame.transform.scale(background_img, (WIDTH, HEIGHT))

# Load h√¨nh t√†u v≈© tr·ª•   
ship_img = pygame.image.load("data/phiThuyen2.png")
ship = pygame.transform.scale(ship_img, (50, 50))

# Load h√¨nh g√†
chicken_img = pygame.image.load("data/ga.png")
chicken_img = pygame.transform.scale(chicken_img, (50, 50))  

# Load h√¨nh ƒë·∫°n
bullet_img = pygame.image.load("data/dan.png")
bullet = pygame.transform.scale(bullet_img, (60, 60))

#Load h√¨nh c·ª•c m√°u r∆°i b·ªï sung cho t√†u
heart_img = pygame.image.load("data/mauBoSung.png")
heart_img = pygame.transform.scale(heart_img, (50, 50))

# ƒê·∫°n c·ªßa g√†
enemy_bullet_img = pygame.image.load("data/dan_ga.png")
enemy_bullet = pygame.transform.scale(enemy_bullet_img, (40, 40))

#ƒê·∫°n c·ªßa boss lv 1
boss_bullet_img = pygame.image.load("data/danBossLV1.png")
boss_bullet = pygame.transform.scale(boss_bullet_img, (40, 40))

# ƒê·∫°n c·ªßa boss lv3
boss_bullet_img_lv3 = pygame.image.load("data/dan_Boss_LV3.png")
boss_bullet_img_lv3 = pygame.transform.scale(boss_bullet_img_lv3, (150, 150)) 

# v·ª• n·ªï khi g√† b·ªã b·∫Øn
explosion_img = pygame.image.load("data/no.png")
explosion_img = pygame.transform.scale(explosion_img, (50, 50))
explosions = []

# Load h√¨nh boss
boss_img = pygame.image.load("data/boss1.png")
boss_img = pygame.transform.scale(boss_img, (100, 100))

# Load h√¨nh boss c·∫•p 2
boss_img_lv2 = pygame.image.load("data/boss2.png")
boss_img_lv2 = pygame.transform.scale(boss_img_lv2, (120, 120))

# Load h√¨nh boss lv3 (2 tr·∫°ng th√°i)
boss_lv3_frames = []
boss_lv3_frames.append(pygame.transform.scale(pygame.image.load("data/boss3_dangThuong.png"), (250, 250)))
boss_lv3_frames.append(pygame.transform.scale(pygame.image.load("data/boss3_dangNangCap.png"), (250, 250)))


# Font ch·ªØ hi·ªÉn th·ªã
font = pygame.font.Font(None, 36)

shake_time = 0  # Th·ªùi gian rung ch·∫•n
shake_intensity = 6  # C∆∞·ªùng ƒë·ªô rung (s·ªë pixel)

# Bi·∫øn input
# This dict maps actions to the corresponding key scancodes.
input_map = menu.input_map

# H√†m v·∫Ω n√∫t ch∆°i l·∫°i
def draw_restart_button():
    restart_text = FONT.render("REPLAY", True, (255, 255, 255))
    pygame.draw.rect(screen, (0, 0, 255), (WIDTH // 2 - 50, HEIGHT // 2 + 50, 100, 40)) 
    text_rect = restart_text.get_rect(center=(WIDTH // 2, HEIGHT // 2 + 70))
    screen.blit(restart_text, text_rect) # Hi·ªÉn th·ªã ch·ªØ "REPLAY" ·ªü gi·ªØa n√∫t ch∆°i l·∫°i 
    return pygame.Rect(WIDTH // 2 - 50, HEIGHT // 2 + 50, 100, 40)

pygame.init()
FONT = pygame.font.Font(None, 40)

BG_COLOR = pygame.Color('gray12') 
GREEN = pygame.Color('lightseagreen')

# Bi·∫øn ƒë·ªÉ qu·∫£n l√Ω v·ªã tr√≠ c·ªßa n·ªÅn
background_y = 0

# H√†m v·∫Ω ch·ªØ "Boss Level 1"
def draw_boss_message(screen):
    global boss_message_display_time
    if boss_message_display_time > 0:  # N·∫øu v·∫´n c√≤n th·ªùi gian hi·ªÉn th·ªã
        font = pygame.font.Font(None, 74)
        text = font.render("BOSS Level 1", True,(255, 0, 255))  # M√†u ch·ªØ ƒë·ªè
        text_rect = text.get_rect(center=(WIDTH // 2, HEIGHT // 2))
        screen.blit(text, text_rect)

# H√†m ki·ªÉm tra rung ch·∫•n
def apply_screen_shake(screen):
    global shake_time, shake_intensity  # Khai b√°o bi·∫øn to√†n c·ª•c
    if shake_time > 0:
        shake_offset_x = random.randint(-shake_intensity, shake_intensity)
        shake_offset_y = random.randint(-shake_intensity, shake_intensity)
        # D·ªãch chuy·ªÉn m√†n h√¨nh
        screen.blit(background, (shake_offset_x, shake_offset_y))  # background l√† h√¨nh n·ªÅn c·ªßa b·∫°n
        shake_time -= 1  # Gi·∫£m th·ªùi gian rung ch·∫•n
    else:
        # Khi h·∫øt rung ch·∫•n, hi·ªÉn th·ªã m√†n h√¨nh b√¨nh th∆∞·ªùng
        screen.blit(background, (0, 0))

def run_game(input_map1=input_map):
    global chicken, background_y, background, shake_time, last_update_time, boss_message_display_time
    # Reset c√°c bi·∫øn game
    ship_x, ship_y = WIDTH // 2, HEIGHT - 100
    ship_speed = 4
    ship_health = 100
    boss_message_display_time = 3000  # Hi·ªÉn th·ªã ch·ªØ "Boss Level 1" trong 3 gi√¢y
    last_update_time = pygame.time.get_ticks()
    chickens = [[random.randint(0, WIDTH - 64), -random.randint(50, 300)] for _ in range(5)]
    chicken_speed = 0.7 # T·ªëc ƒë·ªô di chuy·ªÉn c·ªßa g√†

    hearts = []
    heart_speed = 1

    heart_spawn_delay = random.randint(15000, 20000)  
    last_heart_spawn_time = pygame.time.get_ticks() 
    
    # ƒê·∫°n c·ªßa t√†u v√† g√† 
    bullets = []
    enemy_bullets = []

    # ƒê·∫°n c·ªßa boss
    boss_bullets = []

    fire_delay = 250 # T·ªëc ƒë·ªô b·∫Øn c·ªßa t√†u
    last_shot_time = 0

    enemy_fire_delay = 1010  # t·ªëc ƒë·ªô b·∫Øn c·ªßa g√†
    last_enemy_shot_time = pygame.time.get_ticks()

    boss_bullet_delay = 600 # T·ªëc ƒë·ªô b·∫Øn c·ªßa boss
    last_boss_bullet_time = pygame.time.get_ticks()

    score = 0 # ƒêi·ªÉm s·ªë
    boss = None
    boss_img = None
    boss_health = 300
    boss1_chet = False
    boss2_chet = False 
    running = True
    game_over = False

    boss_level = 1
    boss_respawn_time = None

    pending_boss_spawn = False  # C·ªù ch·ªù xu·∫•t hi·ªán boss level 1 sau rung ch·∫•n

    # Kh·ªüi t·∫°o c√°c bi·∫øn
    
    boss_message_display_time = 0  # Th·ªùi gian hi·ªÉn th·ªã ch·ªØ "Boss Level 1"
    boss_message_duration = 3000  # Th·ªùi gian hi·ªÉn th·ªã (3 gi√¢y)
    boss_message_shown = False  # C·ªù ƒë·ªÉ ki·ªÉm so√°t vi·ªác ƒë√£ hi·ªÉn th·ªã th√¥ng b√°o ch∆∞a

    clock = pygame.time.Clock()

    while running:
        current_time = pygame.time.get_ticks()
        delta_time = current_time - last_update_time
        last_update_time = current_time

        # Di chuy·ªÉn n·ªÅn
        background_y += 0.5
        if background_y >= HEIGHT:
            background_y = 0

        # √Åp d·ª•ng rung ch·∫•n (n·∫øu c√≥)
        if shake_time > 0:
            apply_screen_shake(screen)
        else:
            screen.blit(background, (0, background_y))
            screen.blit(background, (0, background_y - HEIGHT))

        # Hi·ªÉn th·ªã ch·ªØ "Boss Level 1" (n·∫øu c·∫ßn)
        if boss_message_display_time > 0:
            draw_boss_message(screen)
            boss_message_display_time -= delta_time

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
            elif event.type == pygame.KEYDOWN:
                if event.key == pygame.K_ESCAPE:  # Enter the key assignment menu.
                    input_map1 = assignment_menu(input_map1)
            if game_over and event.type == pygame.MOUSEBUTTONDOWN:
                mouse_x, mouse_y = event.pos
                if restart_button.collidepoint(mouse_x, mouse_y):
                    game_over = False  # ƒê·∫∑t l·∫°i tr·∫°ng th√°i game
                    run_game()  # Ch·∫°y l·∫°i game

            if game_over and event.type == pygame.MOUSEBUTTONDOWN:
                mouse_x, mouse_y = event.pos
                if restart_button.collidepoint(mouse_x, mouse_y):
                    game_over = False
                    run_game()
                    continue

        if not game_over:
            # ƒêi·ªÅu khi·ªÉn t√†u v≈© tr·ª•
            keys = pygame.key.get_pressed()
            if keys[input_map1['Move Right']] and ship_x < WIDTH - ship.get_width():
                ship_x += ship_speed
            if keys[input_map1['Move Left']] and ship_x > 0:
                ship_x -= ship_speed
            if keys[input_map1['Move Up']] and ship_y > 200:
                ship_y -= ship_speed
            if keys[input_map1['Move Down']] and ship_y < HEIGHT - ship.get_height():
                ship_y += ship_speed

            if keys[input_map1['Shoot']]:
                current_time = pygame.time.get_ticks()
                if current_time - last_shot_time > fire_delay:
                    if boss_level >= 2 :  # N·∫øu boss ƒë·∫°t c·∫•p 2 th√¨ b·∫Øn 3 vi√™n 
                        bullets.append([ship_x + ship.get_width() // 2 - bullet.get_width() // 2 - 18, ship_y - 40])  # ƒê·∫°n tr√°i
                        bullets.append([ship_x + ship.get_width() // 2 - bullet.get_width() // 2, ship_y - 40])      # ƒê·∫°n gi·ªØa
                        bullets.append([ship_x + ship.get_width() // 2 - bullet.get_width() // 2 + 18, ship_y - 40])  # ƒê·∫°n ph·∫£i
                    else:  # N·∫øu ch∆∞a c√≥ boss lv2 th√¨ b·∫Øn 1 vi√™n b√¨nh th∆∞·ªùng
                        bullets.append([ship_x + ship.get_width() // 2 - bullet.get_width() // 2-2, ship_y - 40])
                    last_shot_time = current_time


            # Di chuy·ªÉn g√†
            for i in range(len(chickens)):
                chickens[i][1] += chicken_speed
                if chickens[i][1] > HEIGHT:
                    chickens[i] = [random.randint(0, WIDTH - 64), -random.randint(50, 300)]

            # C·ª•c m√°u r∆°i b·ªï sung cho t√†u
            for i in range(len(hearts)):
                hearts[i][1] += heart_speed
                if hearts[i][1] > HEIGHT:
                    hearts[i] = [random.randint(0, WIDTH - 64), -random.randint(50, 300)]

            # Boss b·∫Øn ƒë·∫°n
            if boss and current_time - last_boss_bullet_time > boss_bullet_delay and len(boss_bullets) < 300:
                if boss_level == 1:
                    boss_bullets.append([
                        boss[0] + boss_img.get_width() // 2 - boss_bullet_img.get_width() // 2,
                        boss[1] + boss_img.get_height(),
                        0,  # G√≥c
                        1   # üëà L∆∞u th√™m boss_level (1)
                    ])
                
                elif boss_level == 2:
                    for angle in [-20, 0, 20]:
                        boss_bullets.append([
                            boss[0] + boss_img.get_width() // 2 - boss_bullet_img.get_width() // 2,
                            boss[1] + boss_img.get_height(),
                            angle,
                            2  # üëà L∆∞u th√™m boss_level (2)
                        ])
                
                elif boss_level == 3:
                    num_bullets = 20
                    center_x = boss[0] + boss_img.get_width() // 2
                    center_y = boss[1] + boss_img.get_height() // 2
                    speed = 3
                    for i in range(num_bullets):
                        angle = (2 * math.pi / num_bullets) * i
                        vx = speed * math.cos(angle)
                        vy = speed * math.sin(angle)
                        boss_bullets.append([
                            center_x, center_y, vx, vy,
                            3  # üëà L∆∞u th√™m boss_level (3)
                        ])
                
                last_boss_bullet_time = current_time


            # G√† b·∫Øn ƒë·∫°n
            current_time = pygame.time.get_ticks()
            visible_chickens = []  # Kh·ªüi t·∫°o danh s√°ch r·ªóng ƒë·ªÉ tr√°nh l·ªói UnboundLocalError

            if current_time - last_enemy_shot_time > enemy_fire_delay and chickens:
                visible_chickens = [c for c in chickens if c[1] > 0]  # Ch·ªâ ch·ªçn g√† ƒë√£ xu·∫•t hi·ªán

                if visible_chickens:  # Ki·ªÉm tra danh s√°ch c√≥ ph·∫ßn t·ª≠ kh√¥ng
                    chicken = random.choice(visible_chickens)
                    enemy_bullets.append([
                        chicken[0] + chicken_img.get_width() // 2 - enemy_bullet.get_width() // 2, 
                        chicken[1] + chicken_img.get_height()
                    ])
                    last_enemy_shot_time = current_time

            # T·∫°o c·ª•c m√°u r∆°i b·ªï sung cho t√†u
            # Ki·ªÉm tra n·∫øu ƒë√£ ƒë·ªß th·ªùi gian ƒë·ªÉ t·∫°o c·ª•c m√°u m·ªõi
            current_time = pygame.time.get_ticks()
            if current_time - last_heart_spawn_time > heart_spawn_delay:
                hearts.append([random.randint(0, WIDTH - 64), -random.randint(50, 300)])
                last_heart_spawn_time = current_time  # Reset b·ªô ƒë·∫øm th·ªùi gian
                
                # N·∫øu boss c·∫•p 2 tr·ªü l√™n, gi·∫£m th·ªùi gian spawn m√°u
                if boss_level >= 2:
                    heart_spawn_delay = random.randint(10000, 15000)  # 10s - 15s
                else:
                    heart_spawn_delay = random.randint(15000, 20000)  # 15s - 20s (b√¨nh th∆∞·ªùng)



            # Di chuy·ªÉn ƒë·∫°n c·ªßa t√†u
            for b in bullets[:]:
                b[1] -= 4 # ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô b·∫Øn (gi·∫£m: th√¨ gi·∫£m t·ªëc ƒë·ªô b·∫Øn , tƒÉng: th√¨ tƒÉng t·ªëc ƒë·ªô b·∫Øn) 
                if b[1] < 0:
                    bullets.remove(b)

            # Di chuy·ªÉn ƒë·∫°n c·ªßa g√† 
            for eb in enemy_bullets[:]:
                eb[1] += 2  # ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô b·∫Øn ( gi·∫£m: th√¨ gi·∫£m t·ªëc ƒë·ªô b·∫Øn , tƒÉng: th√¨ tƒÉng t·ªëc ƒë·ªô b·∫Øn)
                if eb[1] > HEIGHT:
                    enemy_bullets.remove(eb)

            # Di chuy·ªÉn ƒë·∫°n c·ªßa boss
            for bb in boss_bullets[:]:
                if len(bb) == 5 and bb[4] == 3:
                    bb[0] += bb[2]  # vx
                    bb[1] += bb[3]  # vy
                else:
                    bb[1] += 2
                    bb[0] += int(2 * (bb[2] / 20))
                
                if bb[0] < -50 or bb[0] > WIDTH + 50 or bb[1] < -50 or bb[1] > HEIGHT + 50:
                    boss_bullets.remove(bb)




            # Ki·ªÉm tra va ch·∫°m gi·ªØa t√†u v√† c·ª•c m√°u
            for h in hearts[:]:
                if ((h[0] - ship_x) ** 2 + (h[1] - ship_y) ** 2) ** 0.5 < 40:
                    ship_health = min(ship_health + 10, 100)  # ƒê·∫£m b·∫£o kh√¥ng v∆∞·ª£t 100
                    hearts.remove(h)

            # Ki·ªÉm tra va ch·∫°m gi·ªØa ƒë·∫°n c·ªßa t√†u v√† g√†
            for b in bullets[:]:
                for i in range(len(chickens)):
                    if ((chickens[i][0] - b[0]) ** 2 + (chickens[i][1] - b[1]) ** 2) ** 0.5 < 30:
                        bullets.remove(b)
                        explosions.append([
                            chickens[i][0] + chicken_img.get_width() // 2 - explosion_img.get_width() // 2,
                            chickens[i][1] + chicken_img.get_height() // 2 - explosion_img.get_height() // 2,
                            pygame.time.get_ticks()
                        ])

                        chickens[i] = [random.randint(0, WIDTH - 64), -random.randint(50, 300)]
                        score += 1
                        break

             # Ki·ªÉm tra va ch·∫°m gi·ªØa ƒë·∫°n c·ªßa t√†u v√† boss 
            if boss is not None and isinstance(boss, list) and len(boss) >= 2:
                boss_center_x = boss[0] + boss_img.get_width() // 2
                boss_center_y = boss[1] + boss_img.get_height() // 2

                boss_rect = pygame.Rect(boss[0], boss[1], boss_img.get_width(), boss_img.get_height())

                for b in bullets[:]:
                    if isinstance(b, list) and len(b) >= 2:
                        bullet_rect = pygame.Rect(b[0] + 10, b[1] + 10, bullet.get_width() - 20, bullet.get_height() - 20)
                        if boss_rect.colliderect(bullet_rect):
                            bullets.remove(b)
                            boss_health -= 10
                            if boss_health <= 0:
                                print(f"üî• Boss {boss_level} b·ªã ti√™u di·ªát, ƒë·∫∑t boss = None")

                                boss = None
                                boss_speed = 0
                                boss_health = 0

                                if boss_level == 1:
                                    boss1_chet = True
                                    boss_level = 2
                                elif boss_level == 2:
                                    boss2_chet = True
                                    boss_level = 3
                                elif boss_level == 3:
                                    print("üéâ Boss level 3 ƒë√£ ti√™u di·ªát - K·∫øt th√∫c ho·∫∑c chuy·ªÉn c·∫£nh!")

                                boss_respawn_time = pygame.time.get_ticks()
                                break  # ‚ö° Tho√°t kh·ªèi v√≤ng for b·∫Øn v√†o boss ngay khi boss ch·∫øt




            # Ki·ªÉm tra n·∫øu ƒë·∫°t ƒëi·ªÉm ƒë·ªÉ xu·∫•t hi·ªán boss c·∫•p 1
            # Khi ƒë·ªß ƒëi·ªÉm, kh·ªüi ƒë·ªông rung ch·∫•n v√† hi·ªÉn th·ªã ch·ªØ ‚Äî ch∆∞a t·∫°o boss
            if score >= 5 and boss is None and boss_level == 1 and not pending_boss_spawn:
                shake_time = 90  # Rung ch·∫•n ~1.5 gi√¢y n·∫øu 60 FPS
                boss_message_display_time = 1500  # Hi·ªÉn th·ªã ch·ªØ 1.5 gi√¢y (c√πng th·ªùi gian rung)
                pending_boss_spawn = True  # ƒê√°nh d·∫•u chu·∫©n b·ªã xu·∫•t hi·ªán boss

            # Khi rung ch·∫•n k·∫øt th√∫c, m·ªõi t·∫°o boss
            if pending_boss_spawn and shake_time == 0 and boss is None and boss_level == 1:
                boss = [WIDTH // 2 - 50, 50]
                boss_speed = 0.8
                boss_img = pygame.image.load("data/boss1.png")
                boss_img = pygame.transform.scale(boss_img, (100, 100))
                boss_health = 300

                # ƒê·ªïi nh·∫°c n·ªÅn khi boss xu·∫•t hi·ªán
                pg.mixer.music.stop()
                pg.mixer.music.load("data/nhacnen2.mp3")
                pg.mixer.music.play(-1)

                boss1_chet = False
                pending_boss_spawn = False  # Reset c·ªù

            if boss is not None and boss_level == 1 and boss_health <= 0:
                if not boss1_chet:  # Ch·ªâ ƒë·ªïi nh·∫°c l·∫ßn ƒë·∫ßu khi boss ch·∫øt
                                # ƒê·ªïi l·∫°i nh·∫°c n·ªÅn khi boss lv1 ch·∫øt
                                pg.mixer.music.stop()
                                pg.mixer.music.load("data/nhacnen1.mp3")
                                pg.mixer.music.play(-1)
                                boss1_chet = True
                            
                boss = None  # reset boss
                boss_level = 2  # Chu·∫©n b·ªã cho boss level 2
                boss_respawn_time = pygame.time.get_ticks()            

            if boss is not None and boss_level == 2 and boss_health <= 0:
                if not boss2_chet:
                    print("üî• Boss c·∫•p 2 b·ªã ti√™u di·ªát")
                    boss2_chet = True  
                    boss_respawn_time = pygame.time.get_ticks()
                boss = None
                boss_speed = 0
                boss_health = 0
                boss_level = 3


                

            # Xu·∫•t hi·ªán boss lv ti·∫øp theo sau khi boss lv c≈© b·ªã ti√™u di·ªát 3 gi√¢y
            # Xu·∫•t hi·ªán boss lv ti·∫øp theo sau khi boss c≈© b·ªã ti√™u di·ªát 3 gi√¢y
            if boss is None and boss_respawn_time is not None:
                elapsed_time = pygame.time.get_ticks() - boss_respawn_time
                print(f"‚è≥ ƒê√£ ch·ªù {elapsed_time} ms ƒë·ªÉ h·ªìi sinh boss m·ªõi")

                # H·ªìi sinh boss lv2 n·∫øu ch∆∞a ch·∫øt v√† boss_level ƒëang l√† 2
                if not boss2_chet and boss_level == 2 and score >= 10 and elapsed_time > 3000:
                    print("üî• H·ªìi sinh boss lv2!")
                    boss = [WIDTH // 2 - 60, 50]
                    boss_speed = 0.4
                    boss_img = boss_img_lv2
                    boss_health = 400

                # H·ªìi sinh boss lv3 n·∫øu boss_level l√† 3 (v√† boss2 ƒë√£ ch·∫øt)
                if boss2_chet and boss_level == 3 and score >= 15 and elapsed_time > 3000:
                    print("üî• H·ªìi sinh boss lv3!")
                    boss = [WIDTH // 2 - 75, 50]
                    boss_speed = 0.6
                    boss_health = 500
                    boss_img = boss_lv3_frames[0]  # d√πng ·∫£nh th∆∞·ªùng
                    boss_bullet_delay = 2500


            # Ki·ªÉm tra va ch·∫°m gi·ªØa ƒë·∫°n c·ªßa boss v√† t√†u
            ship_center_x = ship_x + ship.get_width() // 2
            ship_center_y = ship_y + ship.get_height() // 2

            for bb in boss_bullets[:]:
                if len(bb) == 5 and bb[4] == 3:  # boss level 3
                    # Boss lv3 ki·ªÉm tra ƒë·∫°n b·∫Øn v√†o t√†u
                    if ((bb[0] - ship_center_x) ** 2 + (bb[1] - ship_center_y) ** 2) ** 0.5 < 50:
                        boss_bullets.remove(bb)
                        ship_health -= 10
                else:
                    # Boss lv1, lv2 ki·ªÉm tra ƒë·∫°n b·∫Øn v√†o t√†u
                    if ((bb[0] - ship_center_x) ** 2 + (bb[1] - ship_center_y) ** 2) ** 0.5 < 40:
                        boss_bullets.remove(bb)
                        ship_health -= 10





            # Hi·ªÉn th·ªã v·ª• n·ªï
            for explosion in explosions[:]:
                screen.blit(explosion_img, (explosion[0], explosion[1]))
                if pygame.time.get_ticks() - explosion[2] > 500:  # Hi·ªÉn th·ªã trong 500ms
                    explosions.remove(explosion)        

            # Ki·ªÉm tra va ch·∫°m gi·ªØa ƒë·∫°n c·ªßa g√† v√† t√†u
            for eb in enemy_bullets[:]:
                if ((eb[0] - ship_x) ** 2 + (eb[1] - ship_y) ** 2) ** 0.5 < 40:
                    ship_health -= 10
                    enemy_bullets.remove(eb)

        
            # Hi·ªÉn th·ªã ƒë·∫°n c·ªßa boss
            for bb in boss_bullets:
                if len(bb) == 5 and bb[4] == 3:
                    # boss level 3
                    angle = math.degrees(math.atan2(bb[3], bb[2])) - 90  # T√≠nh g√≥c b·∫Øn
                    rotated_bullet = pygame.transform.rotate(boss_bullet_img_lv3, -angle)
                    bullet_rect = rotated_bullet.get_rect(center=(bb[0], bb[1]))
                    screen.blit(rotated_bullet, bullet_rect.topleft)
                else:
                    screen.blit(boss_bullet_img, (bb[0], bb[1]))



            
            if boss is not None:
                boss[0] += boss_speed
                if boss[0] <= 0 or boss[0] >= WIDTH - boss_img.get_width():
                    boss_speed = -boss_speed
                
                if boss_level == 1:
                    screen.blit(boss_img, (boss[0], boss[1]))
                elif boss_level == 2:
                    screen.blit(boss_img_lv2, (boss[0], boss[1]))
                elif boss_level == 3:
                    screen.blit(boss_lv3_frames[0], (boss[0], boss[1]))


            # Ki·ªÉm tra Game Over
            if ship_health <= 0:
                game_over = True

            

        # V·∫Ω t√†u, g√†, ƒë·∫°n
        if not game_over:
            screen.blit(ship, (ship_x, ship_y)) 
            for chicken_x, chicken_y in chickens:
                screen.blit(chicken_img, (chicken_x, chicken_y))
            for b in bullets:
                screen.blit(bullet, (b[0], b[1]))
            for eb in enemy_bullets:
                screen.blit(enemy_bullet, (eb[0], eb[1]))

            for h in hearts:
                screen.blit(heart_img, (h[0], h[1]))

            score_text = FONT.render(f"Score: {score}", True, (255, 255, 255))
            screen.blit(score_text, (WIDTH - 125, 10)) 

            # Hi·ªÉn th·ªã thanh m√°u
            pygame.draw.rect(screen, (255, 0, 0), (10, 10, ship_health * 2, 20))
            pygame.draw.rect(screen, (255, 255, 255), (10, 10, 200, 20), 2)
        else:
            # Hi·ªÉn th·ªã m√†n h√¨nh Game Over
            game_over_text = FONT.render("GAME OVER!", True, (255, 255, 255))
            screen.blit(game_over_text, (WIDTH // 2 - 80, HEIGHT // 2))
            restart_button = draw_restart_button()  # V·∫Ω n√∫t ch∆°i l·∫°i
        clock.tick(60) 
        pygame.display.update()
        
# Main menu function
def main_menu():
    while True:
        screen.blit(BG, (0, 0))

        # Draw title
        screen.blit(BG, (0, 0))
        screen.blit(text, textRect)

        update_buttons(menus["main_menu"])
        draw_buttons(menus["main_menu"])

        start_button = menus["main_menu"][0]
        option_button = menus["main_menu"][1]
        quit_button = menus["main_menu"][2]

        pygame.display.update()

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if event.type == pygame.MOUSEBUTTONDOWN:
                if start_button.rect.collidepoint(event.pos):
                    print("Game Starting...") 
                    return run_game()
                if quit_button.rect.collidepoint(event.pos):
                    pygame.quit()
                    sys.exit()
                if option_button.rect.collidepoint(event.pos):
                    options()  # Open options menu
if __name__ == '__main__':
    main_menu()